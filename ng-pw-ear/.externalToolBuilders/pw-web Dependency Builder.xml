<?xml version="1.0" encoding="UTF-8"?>
<project name="pw-web Dependency Builder" default="build" basedir=".." xmlns:artifact="antlib:org.apache.maven.artifact.ant">
	<import file="${basedir}/build-path.xml" optional="true" />

	<mkdir dir="${pw-ear.target.workspace}" />
	<property name="pw-web.zip.file" location="${pw-ear.target.workspace}/pw-web-jdbc-config.zip" />
	<property name="pw-web.path.file" location="${pw-ear.target.workspace}/pw-web-jdbc-config-path.txt" />
	<available property="pw-web.root" file="${workspace.root.dir}/pw-web" value="${workspace.root.dir}/pw-web" type="dir" />

	<target name="build">
		<antcall target="get.pw-web.from.dir" />
		<antcall target="get.pw-web.from.zip" />
		<runtarget target="eclipse.refresh" />
	</target>

	<target name="clean">
		<if>
			<or>
				<available file="${pw-ear.target.workspace}/pw-web" type="dir" />
				<available file="${pw-web.zip.file}" type="file" />
				<available file="${pw-web.path.file}" type="file" />
			</or>
			<then>
				<echo message="[pw-ear] Cleaning staged pw-web jdbc config file..." />
				<antcall target="delete.pw-ear.target.workspace" />
				<runtarget target="eclipse.refresh" />
			</then>
		</if>
	</target>
	<target name="delete.pw-ear.target.workspace">
		<delete dir="${pw-ear.target.workspace}/pw-web" failonerror="false" />
		<delete file="${pw-web.zip.file}" failonerror="false" />
		<delete file="${pw-web.path.file}" failonerror="false" />
	</target>

	<target name="autobuild.stub">
		<!-- Must run "Auto Build" target for "After a Clean" target to run -->
		<echo message="" />
	</target>

	<target name="get.pw-web.from.dir" if="pw-web.root">
		<antcall target="clean" />
	</target>

	<target name="get.pw-web.from.zip" unless="pw-web.root">
		<if>
			<available file="${pw-web.path.file}" type="file" />
			<then>
				<loadfile srcfile="${pw-web.path.file}" property="pw-web.zip.file.from.repos" />
			</then>
		</if>
		<if>
			<not>
				<available file="${pw-web.zip.file.from.repos}" type="file" />
			</not>
			<then>
				<echo message="[pw-ear] Staging pw-web jdbc config file from zip..." />
				<artifact:pom id="project.pom" file="pom.xml" settingsfile="${eclipse.m2.userSettingsFile}">
					<profile id="eclipse" />
				</artifact:pom>
				<artifact:dependencies pomrefid="project.pom" settingsfile="${eclipse.m2.userSettingsFile}" />
				<propertycopy name="pw-web.location" from="${project.pom.properties.pw-web.groupId}:pw-web:zip:jdbc-config" />
				<echo message="${pw-web.location}" file="${pw-web.path.file}" />
				<var name="pw-web.zip.file.from.repos" unset="true" />
			</then>
		</if>
		<loadfile srcfile="${pw-web.path.file}" property="pw-web.zip.file.from.repos" />
		<outofdate>
			<sourcefiles path="${pw-web.zip.file.from.repos}" />
			<targetfiles path="${pw-web.zip.file}" />
			<sequential>
				<echo message="[pw-ear] Staging pw-web jdbc config file from zip..." />
				<copy file="${pw-web.zip.file.from.repos}" tofile="${pw-web.zip.file}" overwrite="true" preservelastmodified="true" />
				<delete dir="${pw-ear.target.workspace}/pw-web" failonerror="false" />
				<unzip src="${pw-web.zip.file}" dest="${pw-ear.target.workspace}/pw-web" />
			</sequential>
		</outofdate>
	</target>

	<target name="eclipse.refresh" if="eclipse.running">
		<eclipse.refreshLocal resource="pw-ear/target/workspace" depth="infinite" />
	</target>
</project>