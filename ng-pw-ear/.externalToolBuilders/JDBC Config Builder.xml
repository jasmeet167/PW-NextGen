<?xml version="1.0"?>

<project name="JDBC Config Builder" default="build" basedir=".." xmlns:artifact="antlib:org.apache.maven.artifact.ant">
	<import file="${basedir}/build-path.xml" optional="true" />

	<property name="maven.class.path.file" location="${basedir}/target/maven-class-path.txt" />

	<target name="build" depends="get.maven.class.path">
		<echo message="[pw-ear] Building JDBC Configurations..." />
		<if>
			<available file="${workspace.root.dir}/pw-web" type="dir" />
			<then>
				<property name="pw-web.root" location="${workspace.root.dir}/pw-web" />
			</then>
			<else>
				<property name="pw-web.root" location="${pw-ear.target.workspace}/pw-web" />
			</else>
		</if>
		<taskdef name="sbejdbcconfig" classname="com.csc.fsg.life.sbe.taskdefs.JDBCConfigTask" classpath="${maven.class.path}" />
		<ant antfile="${pw-web.root}/jdbc-config.xml">
			<property name="project.root" location="${pw-ear.root}" />
		</ant>
		<runtarget target="eclipse.refresh" />
	</target>

	<target name="clean">
		<echo message="[pw-ear] Cleaning JDBC Configurations..." />
		<delete file="${maven.class.path.file}" failonerror="false" />
		<delete file="${pw-ear.ear.content}/META-INF/ibmconfig/cells/defaultCell/applications/defaultApp/deployments/defaultApp/resources.xml" failonerror="false" />
		<delete file="${pw-ear.ear.content}/META-INF/ibmconfig/cells/defaultCell/security.xml" failonerror="false" />
		<delete dir="${pw-ear.ear.content}/weblogic-ds" failonerror="false" />
		<delete file="${pw-ear.ear.content}/jboss-ds.xml" failonerror="false" />
		<runtarget target="eclipse.refresh" />
	</target>

	<target name="eclipse.refresh" if="eclipse.running">
		<eclipse.refreshLocal resource="pw-ear/target" depth="infinite" />
		<eclipse.refreshLocal resource="pw-ear/src/main/application" depth="infinite" />
	</target>

	<target name="get.maven.class.path" unless="maven.class.path">
		<if>
			<available file="${workspace.root.dir}/life-build" type="dir" />
			<then>
				<property name="maven.class.path" location="${workspace.root.dir}/life-build/target/classes" />
				<delete file="${maven.class.path.file}" failonerror="false" />
			</then>
			<else>
				<if>
					<available file="${maven.class.path.file}" type="file" />
					<then>
						<loadfile srcfile="${maven.class.path.file}" property="maven.class.path" />
					</then>
					<else>
						<echo message="[pw-ear] Getting life-build dependency..." />
						<artifact:dependencies pathid="maven.class.path.ref" settingsfile="${eclipse.m2.userSettingsFile}">
							<pom file="pom.xml" settingsfile="${eclipse.m2.userSettingsFile}">
								<profile id="eclipse" />
							</pom>
						</artifact:dependencies>
						<property name="maven.class.path" refid="maven.class.path.ref" />
						<mkdir dir="${basedir}/target" />
						<echo message="${maven.class.path}" file="${maven.class.path.file}" />
					</else>
				</if>
			</else>
		</if>
	</target>
</project>